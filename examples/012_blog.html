<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Shell</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
</head>
<body style="box-sizing: content-box; margin-inline: auto; max-inline-size: 60vw; margin-top: 10vh;">
  <article>
  <h1>Blog</h1>
  <blog-component></blog-component>
</article>
<script src="./build/cami.cdn.js"></script>
<!-- CDN version below -->
<!-- <script src="https://unpkg.com/cami@latest/build/cami.cdn.js"></script> -->
<script type="module">
  const { html, ReactiveElement, http } = cami;

  class BlogComponent extends ReactiveElement {
    posts = this.query({
      queryKey: ["posts"],
      queryFn: () => {
        return http.get("https://jsonplaceholder.typicode.com/posts").toJson()
      },
      staleTime: 1000 * 60 * 5 // 5 minutes
    })

    addPost = this.mutation({
      mutationFn: (newPost) => {
        return http.post("https://jsonplaceholder.typicode.com/posts", newPost).toJson()
      },
      onMutate: (newPost) => {
        // Snapshot the previous state
        const previousPosts = this.posts.data;

        // Optimistically update to the new value
        this.posts.update(state => {
          state.data = [...state.data, { ...newPost, id: Date.now() }]; // Assuming Date.now() as a temporary ID
        });

        // Return the rollback function and the new post
        return {
          rollback: () => {
            this.posts.update(state => {
              state.data = previousPosts;
            });
          },
          optimisticPost: newPost
        };
      },
      onError: (error, newPost, context) => {
        // Rollback to the previous state
        if (context.rollback) {
          context.rollback();
        }
      },
      onSettled: () => {
        // Invalidate the posts query to refetch the true state
        if (!this.addPost.isSettled) { // Check if the mutation has not been settled
          this.invalidateQueries(['posts']);
        }
      }
    });

    constructor() {
      super();
      this.setup({
        observables: ['posts', 'addPost']
      });
    }

    template() {
      if (this.posts.data) {
        console.log(`Client data has loaded`);
        return html`
          ${this.addPost.status === "pending" ? html`
            <li style="opacity: 0.5;">
              Adding new post...
            </li>
          ` : ''}

          <button @click=${() => this.addPost.mutate({
            title: "New Post",
            body: "This is a new post.",
            userId: 1
          })}>Add Post</button>
          <ul>
            ${this.posts.data.slice().reverse().map(post => html`
              <li>
                <h2>${post.title}</h2>
                <p>${post.body}</p>
              </li>
            `)}
          </ul>
        `;
      }

      if (this.posts.status === "loading") {
        console.log(`Client is loading...`)
        return html`<div>Loading...</div>`;
      }

      if (this.posts.status === "error") {
        console.log(`Client error: ${this.posts.error.message}`);
        return html`<div>Error: ${this.posts.error.message}</div>`;
      }

      if (this.addPost.status === "pending") {
        console.log(`addPost is loading...`);
        return html`<div>Adding post...</div>`;
      }

      if (this.addPost.status === "error") {
        console.log(`addPost error: ${this.addPost.error.message}`);
        return html`<div>Error: ${this.addPost.error.message}</div>`;
      }
    }
  }

  customElements.define('blog-component', BlogComponent);
</script>

</body>
</html>
